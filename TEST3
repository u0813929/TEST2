import React, { useState, useEffect, useMemo, useRef } from 'react';
import { initializeApp } from 'firebase/app';
import { 
  getAuth, 
  signInAnonymously, 
  onAuthStateChanged,
  signInWithCustomToken,
  signInWithEmailAndPassword,
  signOut
} from 'firebase/auth';
import { 
  getFirestore, 
  collection, 
  doc, 
  setDoc, 
  addDoc, 
  deleteDoc, 
  onSnapshot, 
  serverTimestamp,
  getDocs,
  writeBatch
} from 'firebase/firestore';
import { 
  Utensils, 
  ClipboardList, 
  PlusCircle, 
  Trash2, 
  User, 
  ShoppingBag,
  RefreshCw,
  LogOut,
  Settings,
  BookOpen,
  Save,
  Download,
  X,
  AlertCircle,
  CheckCircle2,
  FileSpreadsheet,
  ShoppingCart,
  Send,
  MessageSquare,
  Lock,
  Unlock,
  History,
  Calendar,
  ChevronDown,
  ChevronUp,
  Upload,
  LogIn
} from 'lucide-react';

// --- Firebase åˆå§‹åŒ– ---
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

// --- å‹åˆ¥å®šç¾© ---
interface MenuItem {
  id: string;
  name: string;
  price: number;
}

// è³¼ç‰©è»Šé …ç›®ä»‹é¢
interface CartItem extends MenuItem {
  note: string;
}

interface MenuConfig {
  restaurantName: string;
  isOpen: boolean;
  items: MenuItem[];
  updatedAt?: any;
}

interface Order {
  id: string;
  userId: string;
  userName: string;
  itemName: string;
  itemPrice: number;
  note?: string;
  timestamp: any;
}

interface MenuTemplate {
  id: string;
  restaurantName: string;
  items: MenuItem[];
  createdAt?: any;
}

// æ–°å¢æ­·å²ç´€éŒ„ä»‹é¢
interface HistoryRecord {
  id: string;
  date: any;
  restaurantName: string;
  orders: Order[];
  totalCount: number;
  totalAmount: number;
}

// --- é€šç”¨å…ƒä»¶ï¼šæç¤ºè¨Šæ¯ (Toast) ---
function Toast({ message, type, onClose }: { message: string, type: 'success' | 'error' | 'info', onClose: () => void }) {
  useEffect(() => {
    const timer = setTimeout(onClose, 3000);
    return () => clearTimeout(timer);
  }, [onClose]);

  const bgColors = {
    success: 'bg-green-100 border-green-200 text-green-800',
    error: 'bg-red-100 border-red-200 text-red-800',
    info: 'bg-blue-100 border-blue-200 text-blue-800'
  };

  const Icons = {
    success: CheckCircle2,
    error: AlertCircle,
    info: AlertCircle
  };

  const Icon = Icons[type];

  return (
    <div className={`fixed top-4 left-1/2 transform -translate-x-1/2 z-[60] px-4 py-3 rounded-lg shadow-lg border flex items-center gap-2 ${bgColors[type]} transition-all animate-fade-in-down`}>
      <Icon className="w-5 h-5" />
      <span className="font-medium">{message}</span>
    </div>
  );
}

// --- é€šç”¨å…ƒä»¶ï¼šæ¨¡æ…‹å°è©±æ¡† (Modal) ---
function Modal({ isOpen, title, children, onClose }: { isOpen: boolean, title: string, children: React.ReactNode, onClose: () => void }) {
  if (!isOpen) return null;
  return (
    <div className="fixed inset-0 z-[50] flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm animate-fade-in">
      <div className="bg-white rounded-2xl shadow-xl w-full max-w-md overflow-hidden animate-scale-up flex flex-col max-h-[90vh]">
        <div className="flex justify-between items-center p-4 border-b border-gray-100 shrink-0">
          <h3 className="font-bold text-lg text-gray-800">{title}</h3>
          <button onClick={onClose} className="text-gray-400 hover:text-gray-600 transition-colors">
            <X className="w-5 h-5" />
          </button>
        </div>
        <div className="p-4 overflow-y-auto">
          {children}
        </div>
      </div>
    </div>
  );
}

// --- ç®¡ç†å“¡ç™»å…¥å…ƒä»¶ ---
function AdminLogin({ onCancel, onSuccess }: { onCancel: () => void, onSuccess: () => void }) {
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [error, setError] = useState('');
  const [loggingIn, setLoggingIn] = useState(false);

  const handleLogin = async (e: React.FormEvent) => {
    e.preventDefault();
    setLoggingIn(true);
    setError('');
    try {
      await signInWithEmailAndPassword(auth, email, password);
      onSuccess();
    } catch (err: any) {
      console.error(err);
      if (err.code === 'auth/invalid-credential' || err.code === 'auth/user-not-found' || err.code === 'auth/wrong-password') {
        setError('å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤');
      } else if (err.code === 'auth/too-many-requests') {
        setError('ç™»å…¥å˜—è©¦æ¬¡æ•¸éå¤šï¼Œè«‹ç¨å¾Œå†è©¦');
      } else {
        setError('ç™»å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–ç¨å¾Œå†è©¦');
      }
    } finally {
      setLoggingIn(false);
    }
  };

  return (
    <div className="flex flex-col items-center justify-center min-h-[50vh] p-4 animate-fade-in">
      <div className="bg-white p-8 rounded-2xl shadow-lg w-full max-w-sm border border-gray-100">
        <div className="text-center mb-6">
          <div className="w-16 h-16 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-4">
            <Lock className="w-8 h-8" />
          </div>
          <h2 className="text-2xl font-bold text-gray-800">ç®¡ç†å“¡ç™»å…¥</h2>
          <p className="text-sm text-gray-500 mt-2">è«‹è¼¸å…¥ç®¡ç†å“¡å¸³è™Ÿå¯†ç¢¼ä»¥é€²å…¥å¾Œå°</p>
        </div>

        <form onSubmit={handleLogin} className="space-y-4">
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">Email å¸³è™Ÿ</label>
            <input 
              type="email" 
              value={email}
              onChange={(e) => setEmail(e.target.value)}
              className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"
              placeholder="admin@example.com"
              required
            />
          </div>
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">å¯†ç¢¼</label>
            <input 
              type="password" 
              value={password}
              onChange={(e) => setPassword(e.target.value)}
              className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"
              placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
              required
            />
          </div>
          
          {error && (
            <div className="text-red-500 text-sm bg-red-50 p-2 rounded flex items-center gap-2">
              <AlertCircle className="w-4 h-4" /> {error}
            </div>
          )}

          <button 
            type="submit" 
            disabled={loggingIn}
            className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition-all shadow-sm disabled:opacity-70 flex justify-center items-center gap-2"
          >
            {loggingIn ? 'ç™»å…¥ä¸­...' : <><LogIn className="w-4 h-4" /> ç™»å…¥å¾Œå°</>}
          </button>
          
          <button 
            type="button" 
            onClick={onCancel}
            className="w-full text-gray-500 hover:text-gray-700 font-medium py-2 text-sm"
          >
            è¿”å›å‰å°é»é¤
          </button>
        </form>
      </div>
    </div>
  );
}

// --- ä¸»æ‡‰ç”¨ç¨‹å¼ ---
export default function BentoApp() {
  const [user, setUser] = useState<any>(null);
  const [view, setView] = useState<'user' | 'admin'>('user');
  const [toast, setToast] = useState<{ message: string, type: 'success' | 'error' | 'info' } | null>(null);

  const showToast = (message: string, type: 'success' | 'error' | 'info' = 'info') => {
    setToast({ message, type });
  };
  
  // è³‡æ–™ç‹€æ…‹
  const [menuConfig, setMenuConfig] = useState<MenuConfig>({
    restaurantName: '',
    isOpen: true,
    items: []
  });
  const [orders, setOrders] = useState<Order[]>([]);
  const [loading, setLoading] = useState(true);

  // ä½¿ç”¨è€…è¡¨å–®ç‹€æ…‹
  const [currentUserName, setCurrentUserName] = useState('');
  const [hasJoined, setHasJoined] = useState(false);

  // ç¢ºèªå°è©±æ¡†ç‹€æ…‹
  const [confirmDialog, setConfirmDialog] = useState<{
    isOpen: boolean;
    title: string;
    message: string;
    onConfirm: () => void | Promise<void>;
  }>({ isOpen: false, title: '', message: '', onConfirm: () => {} });

  const openConfirm = (title: string, message: string, onConfirm: () => void | Promise<void>) => {
    setConfirmDialog({ isOpen: true, title, message, onConfirm });
  };

  // --- èªè­‰èˆ‡è³‡æ–™ç›£è½ ---
  useEffect(() => {
    const initAuth = async () => {
      if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
        await signInWithCustomToken(auth, __initial_auth_token);
      } else {
        // é è¨­ç‚ºåŒ¿åç™»å…¥ (ä¸€èˆ¬ä½¿ç”¨è€…)
        await signInAnonymously(auth);
      }
    };
    initAuth();
    
    const unsubscribe = onAuthStateChanged(auth, (u) => {
      setUser(u);
    });
    return () => unsubscribe();
  }, []);

  // ç›£è½èœå–®è¨­å®š
  useEffect(() => {
    if (!user) return; // ç¢ºä¿æœ‰ä½¿ç”¨è€…èº«åˆ†æ‰é–‹å§‹ç›£è½
    
    const menuRef = doc(db, 'artifacts', appId, 'public', 'data', 'bento_content', 'daily_menu');
    
    const unsubMenu = onSnapshot(menuRef, (docSnap) => {
      if (docSnap.exists()) {
        const data = docSnap.data() as MenuConfig;
        setMenuConfig({
          ...data,
          items: Array.isArray(data.items) ? data.items : []
        });
      } else {
        setMenuConfig({ restaurantName: 'å°šæœªè¨­å®š', isOpen: true, items: [] });
      }
      setLoading(false);
    }, (error) => {
      console.error("Menu fetch error", error);
      setLoading(false);
    });

    const ordersRef = collection(db, 'artifacts', appId, 'public', 'data', 'daily_orders');
    
    const unsubOrders = onSnapshot(ordersRef, (snapshot) => {
      const loadedOrders: Order[] = [];
      snapshot.forEach(doc => {
        loadedOrders.push({ id: doc.id, ...doc.data() } as Order);
      });
      loadedOrders.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
      setOrders(loadedOrders);
    }, (error) => {
      console.error("Orders fetch error", error);
    });

    return () => {
      unsubMenu();
      unsubOrders();
    };
  }, [user]); // FIX: åŠ å…¥ user ä½œç‚ºä¾è³´ï¼Œç¢ºä¿åœ¨ç™»å…¥å¾Œé‡æ–°åŸ·è¡Œ

  // --- å•†æ¥­é‚è¼¯ ---

  const saveMenuConfig = async (newConfig: MenuConfig) => {
    if (!user) return;
    try {
      await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'bento_content', 'daily_menu'), {
        ...newConfig,
        updatedAt: serverTimestamp()
      });
      showToast('èœå–®è¨­å®šå·²æ›´æ–°ï¼', 'success');
    } catch (e) {
      console.error(e);
      showToast('æ›´æ–°å¤±æ•—ï¼Œè«‹é‡è©¦', 'error');
    }
  };

  const toggleStoreStatus = async () => {
    if (!user) return;
    const newStatus = !menuConfig.isOpen;
    const actionName = newStatus ? 'é‡æ–°é–‹æ”¾' : 'çµå–®';
    
    openConfirm(
      `${actionName}ç¢ºèª`, 
      `ç¢ºå®šè¦${actionName}å—ï¼Ÿ${!newStatus ? 'çµå–®å¾Œå‰å°å°‡ç„¡æ³•é»é¤ï¼Œä¸¦æœƒé¡¯ç¤ºæ­·å²è¨‚å–®ç´€éŒ„ã€‚' : ''}`, 
      async () => {
        try {
          await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'bento_content', 'daily_menu'), {
            ...menuConfig,
            isOpen: newStatus,
            updatedAt: serverTimestamp()
          });
          showToast(`å·²${actionName}ï¼`, 'success');
        } catch (e) {
          console.error(e);
          showToast('æ“ä½œå¤±æ•—', 'error');
        }
      }
    );
  };

  const submitOrderBatch = async (items: CartItem[]) => {
    if (!user || !currentUserName) {
      showToast('è«‹å…ˆè¼¸å…¥æ‚¨çš„å§“å', 'error');
      return false;
    }
    if (items.length === 0) return false;

    try {
      const batch = writeBatch(db);
      const ordersRef = collection(db, 'artifacts', appId, 'public', 'data', 'daily_orders');

      items.forEach(item => {
        const newDocRef = doc(ordersRef);
        batch.set(newDocRef, {
          userId: user.uid,
          userName: currentUserName,
          itemName: item.name,
          itemPrice: item.price,
          note: item.note || '',
          timestamp: serverTimestamp()
        });
      });

      await batch.commit();
      showToast(`æˆåŠŸé€å‡º ${items.length} ç­†è¨‚å–®ï¼`, 'success');
      return true;
    } catch (e) {
      console.error(e);
      showToast('è¨‚è³¼å¤±æ•—', 'error');
      return false;
    }
  };

  const deleteOrder = async (orderId: string) => {
    openConfirm('åˆªé™¤è¨‚å–®', 'ç¢ºå®šè¦åˆªé™¤é€™ç­†è¨‚å–®å—ï¼Ÿ', async () => {
      try {
        await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'daily_orders', orderId));
        showToast('è¨‚å–®å·²åˆªé™¤', 'success');
      } catch (e) {
        console.error(e);
      }
    });
  };

  const clearAllOrders = async () => {
    openConfirm('æ¸…ç©ºä¸¦å°å­˜', 'é€™å°‡æŠŠç›®å‰çš„è¨‚å–®ç§»å…¥ã€Œæ­·å²ç´€éŒ„ã€ä¸­ä¿å­˜ï¼Œä¸¦æ¸…ç©ºåˆ—è¡¨ä»¥é–‹å§‹æ–°çš„ä¸€å¤©ã€‚ç¢ºå®šå—ï¼Ÿ', async () => {
      try {
        // 1. æº–å‚™å°å­˜è³‡æ–™
        if (orders.length > 0) {
          const historyData = {
            date: serverTimestamp(),
            restaurantName: menuConfig.restaurantName || 'æœªå‘½åé¤å»³',
            orders: orders,
            totalCount: orders.length,
            totalAmount: orders.reduce((sum, o) => sum + (Number(o.itemPrice) || 0), 0)
          };
          
          // 2. å¯«å…¥æ­·å²ç´€éŒ„é›†åˆ
          await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'order_history'), historyData);
        }

        // 3. åˆªé™¤ç¾æœ‰è¨‚å–® (æ‰¹æ¬¡åˆªé™¤)
        const ordersRef = collection(db, 'artifacts', appId, 'public', 'data', 'daily_orders');
        const snapshot = await getDocs(ordersRef);
        const batch = writeBatch(db);
        snapshot.docs.forEach((doc) => {
          batch.delete(doc.ref);
        });
        
        await batch.commit();
        showToast('è¨‚å–®å·²å°å­˜ä¸¦æ¸…ç©ºï¼', 'success');
      } catch (e) {
        console.error(e);
        showToast('å°å­˜å¤±æ•—', 'error');
      }
    });
  };

  // ç™»å‡ºåŠŸèƒ½
  const handleAdminLogout = async () => {
    openConfirm('ç™»å‡ºç¢ºèª', 'ç¢ºå®šè¦ç™»å‡ºå¾Œå°ç®¡ç†å—ï¼Ÿ', async () => {
      try {
        await signOut(auth);
        // ç™»å‡ºå¾Œï¼Œæ¢å¾©ç‚ºåŒ¿åè¨ªå®¢ï¼Œä»¥ä¾¿å¯ä»¥ç¹¼çºŒä½¿ç”¨å‰å°
        await signInAnonymously(auth);
        setView('user');
        showToast('å·²å®‰å…¨ç™»å‡º', 'success');
      } catch (e) {
        console.error(e);
        showToast('ç™»å‡ºå¤±æ•—', 'error');
      }
    });
  };

  const stats = useMemo(() => {
    const summary: Record<string, { count: number, total: number }> = {};
    let grandTotal = 0;
    let totalCount = 0;

    orders.forEach(order => {
      const price = Number(order.itemPrice) || 0;
      const name = order.itemName || 'æœªçŸ¥åç¨±';

      if (!summary[name]) {
        summary[name] = { count: 0, total: 0 };
      }
      summary[name].count += 1;
      summary[name].total += price;
      grandTotal += price;
      totalCount += 1;
    });

    return { summary, grandTotal, totalCount };
  }, [orders]);

  if (loading) return <div className="flex h-screen items-center justify-center text-gray-500">è¼‰å…¥ç³»çµ±ä¸­...</div>;

  // åˆ¤æ–·æ˜¯å¦ç‚ºç®¡ç†å“¡ (éåŒ¿åç™»å…¥)
  const isAdmin = user && !user.isAnonymous;

  return (
    <div className="min-h-screen bg-gray-50 font-sans text-gray-800">
      {toast && <Toast message={toast.message} type={toast.type} onClose={() => setToast(null)} />}
      
      <Modal 
        isOpen={confirmDialog.isOpen} 
        title={confirmDialog.title} 
        onClose={() => setConfirmDialog(prev => ({ ...prev, isOpen: false }))}
      >
        <p className="text-gray-600 mb-6">{confirmDialog.message}</p>
        <div className="flex gap-3 justify-end">
          <button 
            onClick={() => setConfirmDialog(prev => ({ ...prev, isOpen: false }))}
            className="px-4 py-2 text-gray-500 hover:bg-gray-100 rounded-lg transition-colors"
          >
            å–æ¶ˆ
          </button>
          <button 
            onClick={async () => {
              await confirmDialog.onConfirm();
              setConfirmDialog(prev => ({ ...prev, isOpen: false }));
            }}
            className="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors shadow-sm"
          >
            ç¢ºå®šåŸ·è¡Œ
          </button>
        </div>
      </Modal>

      <nav className="bg-white shadow-sm sticky top-0 z-40">
        <div className="max-w-4xl mx-auto px-4 h-16 flex items-center justify-between">
          <div className="flex items-center gap-2 text-orange-600 font-bold text-xl">
            <Utensils className="w-6 h-6" />
            <span>å¥½é£Ÿè¨‚ä¾¿ç•¶</span>
          </div>
          <div className="flex gap-2">
            <button 
              onClick={() => setView('user')}
              className={`px-4 py-2 rounded-full text-sm font-medium transition-colors ${view === 'user' ? 'bg-orange-100 text-orange-700' : 'text-gray-500 hover:bg-gray-100'}`}
            >
              å‰å°é»é¤
            </button>
            <button 
              onClick={() => setView('admin')}
              className={`px-4 py-2 rounded-full text-sm font-medium transition-colors flex items-center gap-1 ${view === 'admin' ? 'bg-blue-100 text-blue-700' : 'text-gray-500 hover:bg-gray-100'}`}
            >
              {isAdmin ? <Lock className="w-3 h-3" /> : <Lock className="w-3 h-3" />} å¾Œå°ç®¡ç†
            </button>
          </div>
        </div>
      </nav>

      <main className="max-w-4xl mx-auto p-4">
        {view === 'user' ? (
          <UserView 
            menuConfig={menuConfig} 
            orders={orders}
            currentUserName={currentUserName}
            setCurrentUserName={setCurrentUserName}
            hasJoined={hasJoined}
            setHasJoined={setHasJoined}
            onSubmitBatch={submitOrderBatch}
            myDelete={deleteOrder}
            showToast={showToast}
            stats={stats}
          />
        ) : (
          // æª¢æŸ¥æ¬Šé™ï¼šå¦‚æœæ˜¯åŒ¿åä½¿ç”¨è€…ï¼Œé¡¯ç¤ºç™»å…¥ç•«é¢ï¼›å¦å‰‡é¡¯ç¤ºå¾Œå°
          !isAdmin ? (
            <AdminLogin 
              onCancel={() => setView('user')} 
              onSuccess={() => showToast('æ­¡è¿å›ä¾†ï¼Œç®¡ç†å“¡ï¼', 'success')}
            />
          ) : (
            <AdminView 
              menuConfig={menuConfig}
              orders={orders}
              stats={stats}
              onSaveConfig={saveMenuConfig}
              onDeleteOrder={deleteOrder}
              onClearOrders={clearAllOrders}
              showToast={showToast}
              openConfirm={openConfirm}
              onToggleStatus={toggleStoreStatus}
              onLogout={handleAdminLogout} // å‚³å…¥ç™»å‡ºåŠŸèƒ½
              user={user} // å‚³å…¥ user ç‰©ä»¶ä»¥ä¾›ä¾è³´æª¢æŸ¥
            />
          )
        )}
      </main>
    </div>
  );
}

// ... UserView (ä¿æŒä¸è®Š) ...
function UserView({ 
  menuConfig, orders, currentUserName, setCurrentUserName, hasJoined, setHasJoined, onSubmitBatch, myDelete, showToast, stats
}: any) {
  const myOrders = orders.filter((o: Order) => o.userName === currentUserName && currentUserName !== '');
  const items = Array.isArray(menuConfig.items) ? menuConfig.items : [];
  const [cart, setCart] = useState<CartItem[]>([]);

  const addToCart = (item: MenuItem) => {
    setCart(prev => [...prev, { ...item, note: '' }]);
    showToast(`å·²åŠ å…¥æ¸…å–®: ${item.name}`, 'success');
  };

  const removeFromCart = (index: number) => {
    setCart(prev => prev.filter((_, i) => i !== index));
  };

  const updateCartNote = (index: number, note: string) => {
    setCart(prev => {
      const newCart = [...prev];
      newCart[index] = { ...newCart[index], note };
      return newCart;
    });
  };

  const handleBatchSubmit = async () => {
    if (cart.length === 0) return;
    const success = await onSubmitBatch(cart);
    if (success) {
      setCart([]); 
    }
  };

  if (!menuConfig.isOpen) {
    return (
      <div className="flex flex-col items-center justify-center py-10 animate-fade-in">
        <div className="text-center mb-8">
          <div className="bg-gray-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
            <LogOut className="w-8 h-8 text-gray-400" />
          </div>
          <h2 className="text-2xl font-bold text-gray-700">ä»Šæ—¥è¨‚é¤å·²æˆªæ­¢</h2>
          <p className="text-gray-500 mt-2">ä»Šæ—¥é¤å»³ï¼š{menuConfig.restaurantName}</p>
          <div className="mt-4 inline-block bg-gray-100 px-4 py-2 rounded-lg">
            <span className="text-gray-600 font-medium">ç¸½è¨ˆï¼š{stats.totalCount} ä»½ / ${stats.grandTotal}</span>
          </div>
        </div>

        <div className="w-full max-w-2xl bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden">
          <div className="bg-gray-50 px-6 py-4 border-b border-gray-100 flex items-center gap-2">
            <ClipboardList className="w-5 h-5 text-gray-500" />
            <h3 className="font-bold text-gray-700">ä»Šæ—¥æ­·å²è¨‚å–®ç´€éŒ„</h3>
          </div>
          <div className="divide-y divide-gray-100">
            {orders.length === 0 ? (
              <div className="p-8 text-center text-gray-400">ä»Šæ—¥ç„¡ä»»ä½•è¨‚å–®</div>
            ) : (
              orders.map((order: Order) => (
                <div key={order.id} className="flex justify-between items-center px-6 py-3 hover:bg-gray-50">
                  <div>
                    <div className="flex items-center gap-2">
                      <span className="font-medium text-gray-800">{order.userName}</span>
                      <span className="text-sm text-gray-500 bg-gray-100 px-2 py-0.5 rounded-full">{order.itemName}</span>
                    </div>
                    {order.note && <div className="text-xs text-gray-400 mt-1">å‚™è¨»: {order.note}</div>}
                  </div>
                  <span className="font-medium text-gray-600">${order.itemPrice}</span>
                </div>
              ))
            )}
          </div>
        </div>
      </div>
    );
  }

  if (!hasJoined) {
    return (
      <div className="max-w-md mx-auto mt-10 bg-white p-8 rounded-2xl shadow-lg text-center animate-scale-up">
        <div className="w-16 h-16 bg-orange-100 text-orange-600 rounded-full flex items-center justify-center mx-auto mb-4">
          <User className="w-8 h-8" />
        </div>
        <h2 className="text-2xl font-bold mb-2">æ­¡è¿é»é¤</h2>
        <p className="text-gray-500 mb-6">
          ä»Šæ—¥é¤å»³ï¼š
          <span className="font-bold text-gray-800 ml-1">
            {menuConfig.restaurantName || 'å°šæœªè¨­å®š'}
          </span>
        </p>
        
        <input 
          type="text" 
          value={currentUserName}
          onChange={(e) => setCurrentUserName(e.target.value)}
          placeholder="è«‹è¼¸å…¥æ‚¨çš„å§“å/æš±ç¨±"
          className="w-full px-4 py-3 border border-gray-200 rounded-xl mb-4 focus:outline-none focus:ring-2 focus:ring-orange-500"
        />
        <button 
          onClick={() => {
            if(currentUserName.trim()) setHasJoined(true);
            else showToast('è«‹è¼¸å…¥åå­—', 'error');
          }}
          className="w-full bg-orange-600 hover:bg-orange-700 text-white font-bold py-3 rounded-xl transition-all shadow-md hover:shadow-lg"
        >
          é–‹å§‹é»é¤
        </button>
      </div>
    );
  }

  return (
    <div className="space-y-6 animate-fade-in pb-20">
      <div className="bg-white p-6 rounded-2xl shadow-sm border border-orange-100">
        <div className="flex justify-between items-start mb-4">
          <div>
            <span className="text-sm text-gray-500">Hi, {currentUserName}</span>
            <h2 className="text-2xl font-bold text-gray-800 mt-1">{menuConfig.restaurantName}</h2>
          </div>
          <button onClick={() => setHasJoined(false)} className="text-xs text-gray-400 hover:text-gray-600 underline">
            æ›´æ›åå­—
          </button>
        </div>
        
        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
          {items.map((item: MenuItem) => (
            <button 
              key={item.id}
              onClick={() => addToCart(item)}
              className="flex items-center justify-between p-4 border border-gray-100 rounded-xl hover:border-orange-500 hover:bg-orange-50 transition-all group bg-white hover:shadow-md"
            >
              <div className="flex items-center gap-3">
                <div className="w-10 h-10 rounded-full bg-gray-100 group-hover:bg-orange-200 flex items-center justify-center text-gray-500 group-hover:text-orange-700 transition-colors">
                  <Utensils className="w-5 h-5" />
                </div>
                <div className="text-left">
                  <div className="font-bold text-gray-800">{item.name}</div>
                  <div className="text-sm text-gray-500">${item.price}</div>
                </div>
              </div>
              <PlusCircle className="w-6 h-6 text-gray-300 group-hover:text-orange-600" />
            </button>
          ))}
        </div>
        {items.length === 0 && (
          <div className="text-center py-10 text-gray-400">
            ç®¡ç†å“¡å°šæœªè¨­å®šèœå–®
          </div>
        )}
      </div>

      {cart.length > 0 && (
        <div className="bg-orange-50 border border-orange-200 p-4 rounded-xl shadow-md border-l-4 border-l-orange-500">
          <h3 className="font-bold text-orange-800 mb-2 flex items-center gap-2">
            <ShoppingBag className="w-5 h-5" />
            å·²é¸æ“‡é¤é» (å°šæœªé€å‡º)
          </h3>
          <ul className="space-y-2 mb-4">
            {cart.map((item, index) => (
              <li key={index} className="flex flex-col gap-2 bg-white p-3 rounded-lg shadow-sm">
                <div className="flex justify-between items-center w-full">
                  <span className="font-medium text-gray-800">
                    {item.name} 
                    <span className="text-gray-400 text-sm ml-1">(${item.price})</span>
                  </span>
                  <button onClick={() => removeFromCart(index)} className="text-gray-400 hover:text-red-600 p-1">
                    <X className="w-4 h-4" />
                  </button>
                </div>
                <div className="flex items-center gap-2 w-full">
                  <MessageSquare className="w-4 h-4 text-gray-400" />
                  <input
                    type="text"
                    value={item.note}
                    onChange={(e) => updateCartNote(index, e.target.value)}
                    placeholder="å‚™è¨» (å¦‚: ä¸åŠ è”¥ã€é£¯å°‘...)"
                    className="flex-1 text-sm bg-gray-50 border border-gray-200 rounded px-2 py-1 focus:outline-none focus:ring-1 focus:ring-orange-300 placeholder-gray-400 text-gray-600"
                  />
                </div>
              </li>
            ))}
          </ul>
          <div className="flex justify-between items-center pt-3 border-t border-orange-200">
            <span className="font-bold text-orange-800">
              å°è¨ˆ: ${cart.reduce((sum, item) => sum + item.price, 0)}
            </span>
            <button 
              onClick={handleBatchSubmit}
              className="bg-orange-600 hover:bg-orange-700 text-white px-6 py-2 rounded-lg font-bold shadow-sm transition-all flex items-center gap-2"
            >
              <Send className="w-4 h-4" /> é€å‡ºè¨‚å–®
            </button>
          </div>
        </div>
      )}

      {myOrders.length > 0 && (
        <div className="bg-green-50 border border-green-200 p-4 rounded-xl opacity-80 hover:opacity-100 transition-opacity">
          <h3 className="font-bold text-green-800 mb-2 flex items-center gap-2">
            <ShoppingBag className="w-5 h-5" />
            æ­·å²è¨‚å–® (å·²é€å‡º)
          </h3>
          <ul className="space-y-2">
            {myOrders.map((order: Order) => (
              <li key={order.id} className="flex flex-col bg-white p-2 rounded-lg shadow-sm">
                <div className="flex justify-between items-center">
                  <span>
                    {order.itemName} 
                    <span className="text-gray-400 text-sm ml-1">(${order.itemPrice})</span>
                  </span>
                  <button onClick={() => myDelete(order.id)} className="text-red-400 hover:text-red-600 p-1">
                    <Trash2 className="w-4 h-4" />
                  </button>
                </div>
                {order.note && (
                  <div className="text-xs text-gray-500 mt-1 pl-1 border-l-2 border-green-200">
                    å‚™è¨»: {order.note}
                  </div>
                )}
              </li>
            ))}
          </ul>
          <div className="mt-3 pt-3 border-t border-green-200 text-right font-bold text-green-800">
            ç¸½è¨ˆ: ${myOrders.reduce((sum: number, o: Order) => sum + (Number(o.itemPrice) || 0), 0)}
          </div>
        </div>
      )}
      
      <div className="text-center text-sm text-gray-400 mt-8">
        ç›®å‰å…¨é«”å·²è¨‚è³¼ {orders.length} ä»½é¤é»
      </div>
    </div>
  );
}

function AdminView({ menuConfig, orders, stats, onSaveConfig, onDeleteOrder, onClearOrders, showToast, openConfirm, onToggleStatus, onLogout, user }: any) {
  const [editingConfig, setEditingConfig] = useState<MenuConfig>(menuConfig);
  const [newItemName, setNewItemName] = useState('');
  const [newItemPrice, setNewItemPrice] = useState('');
  
  const [templates, setTemplates] = useState<MenuTemplate[]>([]);
  const [isSaveModalOpen, setIsSaveModalOpen] = useState(false);
  const [templateNameInput, setTemplateNameInput] = useState('');

  // æ­·å²ç´€éŒ„ç›¸é—œç‹€æ…‹
  const [isHistoryModalOpen, setIsHistoryModalOpen] = useState(false);
  const [historyRecords, setHistoryRecords] = useState<HistoryRecord[]>([]);
  const [expandedHistoryId, setExpandedHistoryId] = useState<string | null>(null);

  // æª”æ¡ˆä¸Šå‚³ Ref
  const fileInputRef = useRef<HTMLInputElement>(null);

  useEffect(() => {
    setEditingConfig({
      ...menuConfig,
      items: Array.isArray(menuConfig.items) ? menuConfig.items : []
    });
  }, [menuConfig]);

  useEffect(() => {
    if (!user) return;
    const templatesRef = collection(db, 'artifacts', appId, 'public', 'data', 'menu_templates');
    const unsubscribe = onSnapshot(templatesRef, (snapshot) => {
      const loadedTemplates: MenuTemplate[] = [];
      snapshot.forEach(doc => {
        const data = doc.data();
        loadedTemplates.push({ 
          id: doc.id, 
          restaurantName: data.restaurantName,
          items: Array.isArray(data.items) ? data.items : [],
          createdAt: data.createdAt
        });
      });
      
      loadedTemplates.sort((a, b) => {
        const timeA = a.createdAt?.seconds || 0;
        const timeB = b.createdAt?.seconds || 0;
        return timeB - timeA;
      });

      setTemplates(loadedTemplates);
    }, (error) => {
      console.error("Templates fetch error", error);
    });
    return () => unsubscribe();
  }, [user]);

  // ç›£è½æ­·å²ç´€éŒ„
  useEffect(() => {
    if (!user) return;
    if (!isHistoryModalOpen) return; // åªåœ¨æ‰“é–‹ Modal æ™‚ç›£è½

    const historyRef = collection(db, 'artifacts', appId, 'public', 'data', 'order_history');
    const unsubscribe = onSnapshot(historyRef, (snapshot) => {
      const loadedHistory: HistoryRecord[] = [];
      snapshot.forEach(doc => {
        const data = doc.data();
        loadedHistory.push({
          id: doc.id,
          date: data.date,
          restaurantName: data.restaurantName,
          orders: Array.isArray(data.orders) ? data.orders : [],
          totalCount: data.totalCount || 0,
          totalAmount: data.totalAmount || 0
        });
      });

      // ä¾æ—¥æœŸæ’åº (æœ€æ–°çš„åœ¨æœ€ä¸Šé¢)
      loadedHistory.sort((a, b) => (b.date?.seconds || 0) - (a.date?.seconds || 0));
      setHistoryRecords(loadedHistory);
    });

    return () => unsubscribe();
  }, [isHistoryModalOpen, user]);

  const handleAddItem = () => {
    if (!newItemName || !newItemPrice) return;
    const newItem: MenuItem = {
      id: Date.now().toString(),
      name: newItemName,
      price: parseInt(newItemPrice) || 0
    };
    setEditingConfig(prev => ({
      ...prev,
      items: [...prev.items, newItem]
    }));
    setNewItemName('');
    setNewItemPrice('');
  };

  const handleRemoveItem = (id: string) => {
    setEditingConfig(prev => ({
      ...prev,
      items: prev.items.filter(item => item.id !== id)
    }));
  };

  const handleSave = () => {
    onSaveConfig(editingConfig);
  };

  const handleOpenSaveModal = () => {
    if (!editingConfig.restaurantName) {
      showToast('è«‹å…ˆè¼¸å…¥é¤å»³åç¨±æ‰èƒ½å„²å­˜ç‚ºç¯„æœ¬', 'error');
      return;
    }
    setTemplateNameInput(editingConfig.restaurantName);
    setIsSaveModalOpen(true);
  };

  const handleConfirmSaveTemplate = async () => {
    if (!templateNameInput) {
      showToast('è«‹è¼¸å…¥ç¯„æœ¬åç¨±', 'error');
      return;
    }

    try {
      await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'menu_templates'), {
        restaurantName: templateNameInput, 
        items: editingConfig.items,
        createdAt: serverTimestamp()
      });
      setIsSaveModalOpen(false);
      showToast(`å·²å°‡ã€Œ${templateNameInput}ã€åŠ å…¥å¸¸ç”¨èœå–®åº«ï¼`, 'success');
    } catch (e) {
      console.error(e);
      showToast('å„²å­˜ç¯„æœ¬å¤±æ•—', 'error');
    }
  };

  const handleLoadTemplate = (template: MenuTemplate) => {
    openConfirm('è¼‰å…¥ç¯„æœ¬', `ç¢ºå®šè¦è¼‰å…¥ã€Œ${template.restaurantName}ã€çš„èœå–®å—ï¼Ÿç›®å‰çš„ç·¨è¼¯å…§å®¹å°‡è¢«è¦†è“‹ã€‚`, () => {
      setEditingConfig(prev => ({
        ...prev,
        restaurantName: template.restaurantName,
        items: template.items
      }));
      showToast('ç¯„æœ¬å·²è¼‰å…¥', 'success');
    });
  };

  const handleDeleteTemplate = async (id: string, name: string) => {
    openConfirm('åˆªé™¤ç¯„æœ¬', `ç¢ºå®šè¦åˆªé™¤ã€Œ${name}ã€é€™å€‹å¸¸ç”¨èœå–®å—ï¼Ÿ`, async () => {
      try {
        await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'menu_templates', id));
        showToast('ç¯„æœ¬å·²åˆªé™¤', 'success');
      } catch (e) {
        console.error(e);
        showToast('åˆªé™¤å¤±æ•—', 'error');
      }
    });
  };

  // é€šç”¨åŒ¯å‡º CSV åŠŸèƒ½ (æ”¯æ´ç•¶æ—¥è¨‚å–®èˆ‡æ­·å²è¨‚å–®)
  const exportOrdersToCSV = (ordersToExport: Order[], fileName: string) => {
    if (ordersToExport.length === 0) {
      showToast('ç›®å‰æ²’æœ‰è¨‚å–®å¯ä»¥åŒ¯å‡º', 'info');
      return;
    }

    const totalCount = ordersToExport.length;
    const totalAmount = ordersToExport.reduce((sum: number, order: Order) => sum + (Number(order.itemPrice) || 0), 0);

    const headers = ['ä¸‹å–®æ™‚é–“', 'å§“å', 'å“é …', 'åƒ¹æ ¼', 'å‚™è¨»'];
    
    const csvContent = ordersToExport.map((order: Order) => {
      let timeStr = '';
      if (order.timestamp && order.timestamp.seconds) {
        const date = new Date(order.timestamp.seconds * 1000);
        timeStr = date.toLocaleString('zh-TW', { hour12: false });
      } else {
        timeStr = 'è™•ç†ä¸­...';
      }
      
      const safeName = order.userName ? order.userName.replace(/"/g, '""') : '';
      const safeItem = order.itemName ? order.itemName.replace(/"/g, '""') : '';
      const safeNote = order.note ? order.note.replace(/"/g, '""') : '';
      
      return `"${timeStr}","${safeName}","${safeItem}",${order.itemPrice},"${safeNote}"`;
    });

    csvContent.push(''); 
    csvContent.push(`,,ç¸½ä»½æ•¸,${totalCount},`);
    csvContent.push(`,,ç¸½é‡‘é¡,${totalAmount},`);

    const csvString = '\uFEFF' + [headers.join(','), ...csvContent].join('\n');
    
    const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = fileName;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    showToast('å·²åŒ¯å‡º CSV æª”æ¡ˆ (å«çµ±è¨ˆè³‡è¨Š)', 'success');
  };

  // åŒ¯å‡ºç•¶æ—¥è¨‚å–® (Wrapper)
  const handleExportCurrentOrders = () => {
    exportOrdersToCSV(orders, `è¨‚ä¾¿ç•¶çµ±è¨ˆ_${new Date().toISOString().slice(0, 10)}.csv`);
  };

  // è™•ç†æª”æ¡ˆä¸Šå‚³
  const handleFileUpload = (event: React.ChangeEvent<HTMLInputElement>) => {
    const file = event.target.files?.[0];
    if (!file) return;

    // è§£ææª”åï¼šç§»é™¤ .csv ä»¥åŠ Google ä¸‹è¼‰å¸¸è¦‹çš„ " - å·¥ä½œè¡¨1"
    let restaurantName = file.name.replace(/\.csv$/i, '');
    restaurantName = restaurantName.replace(/ - å·¥ä½œè¡¨1$/, '');

    const reader = new FileReader();
    reader.onload = async (e) => {
      const text = e.target?.result as string;
      if (!text) return;

      const lines = text.split(/\r\n|\n/); // Handle both line endings
      const newItems: MenuItem[] = [];

      lines.forEach(line => {
        const cleanLine = line.trim();
        if (!cleanLine) return;

        let name = '';
        let price = 0;

        // ç­–ç•¥ 1: æ ¹æ“šä½¿ç”¨è€…æä¾›çš„æ ¼å¼ "ç·¨è™Ÿ å“å $ åƒ¹æ ¼"
        if (cleanLine.includes('$')) {
          const parts = cleanLine.split('$');
          const namePart = parts[0].trim();
          const pricePart = parts[1].trim();
          
          // ç§»é™¤é–‹é ­çš„ç·¨è™Ÿ (ä¾‹å¦‚ "1 ", "02 ")
          name = namePart.replace(/^[\d\s\.]+/, ''); 
          price = parseInt(pricePart.replace(/[^\d]/g, '')); // åªç•™æ•¸å­—
        } 
        // ç­–ç•¥ 2: æ¨™æº– CSV æ ¼å¼ "å“å,åƒ¹æ ¼" (ä»¥é˜²è¬ä¸€)
        else if (cleanLine.includes(',')) {
          const lastCommaIndex = cleanLine.lastIndexOf(',');
          const namePart = cleanLine.substring(0, lastCommaIndex).trim();
          const pricePart = cleanLine.substring(lastCommaIndex + 1).trim();
          
          name = namePart.replace(/^[\d\s\.]+/, '');
          price = parseInt(pricePart.replace(/[^\d]/g, ''));
        }

        if (name && !isNaN(price) && price > 0) {
          newItems.push({
            id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
            name: name,
            price: price
          });
        }
      });

      if (newItems.length > 0) {
        try {
          await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'menu_templates'), {
            restaurantName: restaurantName,
            items: newItems,
            createdAt: serverTimestamp()
          });
          showToast(`å·²æˆåŠŸåŒ¯å…¥ã€Œ${restaurantName}ã€ï¼Œå…± ${newItems.length} å€‹å“é …ï¼`, 'success');
        } catch (error) {
          console.error("Import failed", error);
          showToast('åŒ¯å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
        }
      } else {
        showToast('ç„¡æ³•è§£ææª”æ¡ˆå…§å®¹ï¼Œè«‹ç¢ºèªæ ¼å¼æ˜¯å¦æ­£ç¢º (åç¨± $ åƒ¹æ ¼)', 'error');
      }
      
      if (fileInputRef.current) {
        fileInputRef.current.value = '';
      }
    };
    reader.readAsText(file);
  };

  return (
    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 animate-fade-in">
      {/* å„²å­˜ç¯„æœ¬ Modal */}
      <Modal 
        isOpen={isSaveModalOpen} 
        title="å„²å­˜ç‚ºå¸¸ç”¨èœå–®" 
        onClose={() => setIsSaveModalOpen(false)}
      >
        <div className="space-y-4">
          <p className="text-gray-600 text-sm">è«‹ç‚ºé€™ä»½èœå–®è¨­å®šä¸€å€‹å¥½è¨˜çš„åç¨±ï¼ˆä¾‹å¦‚ï¼šå¿…å‹å®¢ã€å··å£éºµåº—ï¼‰ï¼Œæ–¹ä¾¿ä¸‹æ¬¡å¿«é€Ÿè¼‰å…¥ã€‚</p>
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">ç¯„æœ¬åç¨±</label>
            <input 
              type="text" 
              value={templateNameInput}
              onChange={(e) => setTemplateNameInput(e.target.value)}
              className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"
              placeholder="è¼¸å…¥åç¨±..."
              autoFocus
            />
          </div>
          <div className="flex justify-end gap-3 pt-2">
            <button 
              onClick={() => setIsSaveModalOpen(false)}
              className="px-4 py-2 text-gray-500 hover:bg-gray-100 rounded-lg transition-colors"
            >
              å–æ¶ˆ
            </button>
            <button 
              onClick={handleConfirmSaveTemplate}
              className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors shadow-sm flex items-center gap-2"
            >
              <Save className="w-4 h-4" /> ç¢ºèªå„²å­˜
            </button>
          </div>
        </div>
      </Modal>

      {/* æ­·å²ç´€éŒ„ Modal */}
      <Modal
        isOpen={isHistoryModalOpen}
        title="ğŸ“œ æ­·å²è¨‚å–®ç´€éŒ„"
        onClose={() => setIsHistoryModalOpen(false)}
      >
        <div className="space-y-4 min-w-[300px]">
          {historyRecords.length === 0 ? (
            <div className="text-center text-gray-400 py-8">ç›®å‰æ²’æœ‰å°å­˜çš„æ­·å²ç´€éŒ„</div>
          ) : (
            historyRecords.map((record) => (
              <div key={record.id} className="border border-gray-200 rounded-lg overflow-hidden">
                <div 
                  className="w-full flex justify-between items-center p-4 bg-gray-50 hover:bg-gray-100 transition-colors cursor-pointer"
                  onClick={() => setExpandedHistoryId(expandedHistoryId === record.id ? null : record.id)}
                >
                  <div>
                    <div className="font-bold text-gray-800 flex items-center gap-2">
                      <Calendar className="w-4 h-4 text-gray-500" />
                      {record.date ? new Date(record.date.seconds * 1000).toLocaleDateString() : 'æœªçŸ¥æ—¥æœŸ'}
                      <span className="text-gray-400 font-normal">|</span>
                      {record.restaurantName}
                    </div>
                    <div className="text-sm text-gray-500 mt-1">
                      ç¸½è¨ˆ: {record.totalCount} ä»½ / ${record.totalAmount}
                    </div>
                  </div>
                  <div className="flex items-center gap-3">
                    {/* åŒ¯å‡ºæ­·å²ç´€éŒ„æŒ‰éˆ• */}
                    <button 
                      onClick={(e) => {
                        e.stopPropagation(); // é˜²æ­¢è§¸ç™¼å±•é–‹/æ”¶åˆ
                        const dateStr = record.date ? new Date(record.date.seconds * 1000).toISOString().slice(0, 10) : 'unknown_date';
                        exportOrdersToCSV(record.orders, `æ­·å²è¨‚å–®_${dateStr}_${record.restaurantName}.csv`);
                      }}
                      className="p-2 bg-white text-green-600 rounded-full hover:bg-green-50 border border-green-200 shadow-sm"
                      title="åŒ¯å‡ºæ­¤ç´€éŒ„"
                    >
                      <FileSpreadsheet className="w-4 h-4" />
                    </button>
                    {expandedHistoryId === record.id ? <ChevronUp className="w-5 h-5 text-gray-400" /> : <ChevronDown className="w-5 h-5 text-gray-400" />}
                  </div>
                </div>
                
                {expandedHistoryId === record.id && (
                  <div className="p-4 bg-white border-t border-gray-200">
                    <table className="w-full text-sm">
                      <thead className="text-gray-500 bg-gray-50">
                        <tr>
                          <th className="px-2 py-1 text-left">å§“å</th>
                          <th className="px-2 py-1 text-left">å“é …</th>
                          <th className="px-2 py-1 text-left">å‚™è¨»</th>
                          <th className="px-2 py-1 text-right">åƒ¹æ ¼</th>
                        </tr>
                      </thead>
                      <tbody className="divide-y divide-gray-100">
                        {record.orders.map((order, idx) => (
                          <tr key={idx}>
                            <td className="px-2 py-2">{order.userName}</td>
                            <td className="px-2 py-2">{order.itemName}</td>
                            <td className="px-2 py-2 text-gray-400 text-xs">{order.note || '-'}</td>
                            <td className="px-2 py-2 text-right">${order.itemPrice}</td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                )}
              </div>
            ))
          )}
        </div>
      </Modal>

      <div className="space-y-6">
        <div className="bg-white p-6 rounded-2xl shadow-sm border border-amber-100">
          <div className="flex items-center justify-between mb-4 border-b border-amber-100 pb-2">
            <div className="flex items-center gap-2 text-amber-800 font-bold">
              <BookOpen className="w-5 h-5" />
              <h3>å¸¸ç”¨èœå–®åº«</h3>
            </div>
            <div className="flex gap-2">
              <button
                onClick={() => fileInputRef.current?.click()}
                className="text-sm bg-green-100 text-green-700 hover:bg-green-200 border border-green-200 flex items-center gap-1 px-2 py-1 rounded transition-colors"
                title="å¾ Google è©¦ç®—è¡¨åŒ¯å‡ºä¹‹ CSV æª”æ¡ˆåŒ¯å…¥"
              >
                <Upload className="w-4 h-4" />
                åŒ¯å…¥ Google è¡¨å–® (CSV)
              </button>
              <input 
                type="file" 
                ref={fileInputRef} 
                onChange={handleFileUpload} 
                accept=".csv" 
                className="hidden" 
              />
              
              <button
                onClick={() => setIsHistoryModalOpen(true)}
                className="text-sm text-amber-600 hover:text-amber-800 flex items-center gap-1 px-2 py-1 rounded hover:bg-amber-50 transition-colors"
              >
                <History className="w-4 h-4" />
                æŸ¥çœ‹æ­·å²ç´€éŒ„
              </button>
            </div>
          </div>
          
          <div className="grid grid-cols-1 gap-2 max-h-48 overflow-y-auto pr-1">
            {templates.map(template => (
              <div key={template.id} className="flex justify-between items-center bg-amber-50 p-3 rounded-lg border border-amber-200">
                <span className="font-medium text-amber-900">{template.restaurantName}</span>
                <div className="flex gap-2">
                  <button 
                    onClick={() => handleLoadTemplate(template)}
                    className="p-1.5 bg-white text-blue-600 rounded shadow-sm hover:bg-blue-50 border border-blue-100"
                    title="è¼‰å…¥æ­¤èœå–®"
                  >
                    <Download className="w-4 h-4" />
                  </button>
                  <button 
                    onClick={() => handleDeleteTemplate(template.id, template.restaurantName)}
                    className="p-1.5 bg-white text-red-400 rounded shadow-sm hover:bg-red-50 border border-red-100"
                    title="åˆªé™¤"
                  >
                    <Trash2 className="w-4 h-4" />
                  </button>
                </div>
              </div>
            ))}
            {templates.length === 0 && (
              <div className="text-center text-gray-400 py-4 text-sm">
                ç›®å‰æ²’æœ‰å„²å­˜çš„èœå–®ç¯„æœ¬
              </div>
            )}
          </div>
        </div>

        <div className="bg-white p-6 rounded-2xl shadow-sm border border-blue-100">
          <div className="flex items-center gap-2 mb-4 text-blue-800 font-bold border-b border-blue-100 pb-2">
            <Settings className="w-5 h-5" />
            <h3>ä»Šæ—¥èœå–®è¨­å®š</h3>
          </div>

          <div className="space-y-4">
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">é¤å»³åç¨±</label>
              <input 
                type="text" 
                value={editingConfig.restaurantName || ''}
                onChange={(e) => setEditingConfig({...editingConfig, restaurantName: e.target.value})}
                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"
                placeholder="ä¾‹å¦‚ï¼šæ­£å¿ æ’éª¨é£¯"
              />
            </div>
            
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">æ–°å¢å“é …</label>
              <div className="flex gap-2">
                <input 
                  type="text" 
                  value={newItemName}
                  onChange={(e) => setNewItemName(e.target.value)}
                  placeholder="å“å (å¦‚: é›è…¿é£¯)"
                  className="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"
                />
                <input 
                  type="number" 
                  value={newItemPrice}
                  onChange={(e) => setNewItemPrice(e.target.value)}
                  placeholder="åƒ¹æ ¼"
                  className="w-24 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"
                />
                <button 
                  onClick={handleAddItem}
                  className="bg-blue-600 text-white p-2 rounded-lg hover:bg-blue-700"
                >
                  <PlusCircle className="w-5 h-5" />
                </button>
              </div>
            </div>

            <div className="space-y-2 max-h-48 overflow-y-auto pr-1">
              {editingConfig.items.map((item, idx) => (
                <div key={idx} className="flex justify-between items-center bg-gray-50 p-2 rounded border border-gray-200">
                  <span className="text-sm">{item.name} (${item.price})</span>
                  <button onClick={() => handleRemoveItem(item.id)} className="text-red-400 hover:text-red-600">
                    <Trash2 className="w-4 h-4" />
                  </button>
                </div>
              ))}
              {editingConfig.items.length === 0 && <div className="text-gray-400 text-sm text-center">å°šæœªæ–°å¢å“é …</div>}
            </div>

            <div className="flex items-center justify-between pt-4 border-t border-gray-100 gap-2">
              <button
                onClick={onToggleStatus}
                className={`flex items-center gap-2 px-4 py-2 rounded-lg font-bold text-white shadow-sm transition-all mr-auto ${
                  editingConfig.isOpen 
                    ? 'bg-red-500 hover:bg-red-600' 
                    : 'bg-green-500 hover:bg-green-600'
                }`}
              >
                {editingConfig.isOpen ? (
                  <>
                    <Lock className="w-4 h-4" />
                    ç«‹å³çµå–®
                  </>
                ) : (
                  <>
                    <Unlock className="w-4 h-4" />
                    é‡æ–°é–‹æ”¾
                  </>
                )}
              </button>

              <button 
                onClick={handleOpenSaveModal}
                className="bg-amber-100 hover:bg-amber-200 text-amber-800 px-4 py-2 rounded-lg font-medium shadow-sm transition-all flex items-center gap-1 text-sm"
                title="å°‡ç›®å‰è¨­å®šå­˜å…¥å¸¸ç”¨èœå–®"
              >
                <Save className="w-4 h-4" /> å­˜ç‚ºç¯„æœ¬
              </button>

              <button 
                onClick={handleSave}
                className="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-medium shadow transition-all"
              >
                å„²å­˜è¨­å®š
              </button>
            </div>
          </div>
        </div>

        <div className="bg-white p-6 rounded-2xl shadow-sm border border-red-100">
          <div className="flex items-center gap-2 mb-4 text-red-800 font-bold border-b border-red-100 pb-2">
            <RefreshCw className="w-5 h-5" />
            <h3>æ¯æ—¥é‡ç½®</h3>
          </div>
          <p className="text-sm text-gray-500 mb-4">æ–°çš„ä¸€å¤©é–‹å§‹å‰ï¼Œè«‹æŒ‰æ­¤æŒ‰éˆ•å°å­˜ä¸¦æ¸…ç©ºæ˜¨æ—¥çš„è¨‚å–®ã€‚</p>
          <button 
            onClick={onClearOrders}
            className="w-full border border-red-200 text-red-600 hover:bg-red-50 font-bold py-2 rounded-lg transition-colors flex items-center justify-center gap-2"
          >
            <Trash2 className="w-4 h-4" /> æ¸…ç©ºä¸¦å°å­˜ä»Šæ—¥è¨‚å–®
          </button>
        </div>

        {/* ç™»å‡ºæŒ‰éˆ• */}
        <div className="flex justify-end mt-4">
          <button 
            onClick={onLogout}
            className="text-gray-500 hover:text-red-600 text-sm font-medium transition-colors flex items-center gap-1"
          >
            <LogOut className="w-4 h-4" /> ç™»å‡ºç®¡ç†å“¡
          </button>
        </div>
      </div>

      <div className="space-y-6">
        <div className="bg-white p-6 rounded-2xl shadow-sm border border-purple-100">
          <div className="flex items-center gap-2 mb-4 text-purple-800 font-bold border-b border-purple-100 pb-2">
            <ClipboardList className="w-5 h-5" />
            <h3>è¨‚è³¼çµ±è¨ˆ</h3>
          </div>
          
          <div className="space-y-3">
            {Object.entries(stats.summary).map(([name, data]: [string, any]) => (
              <div key={name} className="flex justify-between items-center bg-purple-50 p-3 rounded-lg">
                <span className="font-medium text-gray-800">{name}</span>
                <div className="flex gap-4 text-sm">
                  <span className="font-bold bg-white px-2 py-0.5 rounded text-purple-700">x {data.count}</span>
                  <span className="text-gray-500 w-16 text-right">${data.total}</span>
                </div>
              </div>
            ))}
            {stats.totalCount === 0 && <div className="text-center text-gray-400 py-4">ç›®å‰å°šç„¡è¨‚å–®</div>}
            
            <div className="flex justify-between items-center pt-4 mt-2 border-t-2 border-dashed border-gray-200 font-bold text-lg">
              <span>ç¸½è¨ˆ</span>
              <div className="flex gap-4">
                <span className="text-gray-500 text-sm flex items-center">{stats.totalCount} ä»½</span>
                <span className="text-purple-700">${stats.grandTotal}</span>
              </div>
            </div>
          </div>
        </div>

        <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-200">
          <div className="flex justify-between items-center mb-4">
            <h3 className="font-bold text-gray-800">è¨‚å–®æ˜ç´°åˆ—è¡¨</h3>
            <button
              onClick={handleExportCurrentOrders}
              className="flex items-center gap-2 px-3 py-1.5 text-sm bg-green-100 text-green-700 hover:bg-green-200 rounded-lg transition-colors font-medium border border-green-200"
              title="åŒ¯å‡ºç‚º CSV (å¯é–‹å•Ÿæ–¼ Excel æˆ– Google è©¦ç®—è¡¨)"
            >
              <FileSpreadsheet className="w-4 h-4" />
              åŒ¯å‡ºçµ±è¨ˆè¡¨
            </button>
          </div>
          <div className="overflow-hidden">
            <table className="min-w-full text-left text-sm">
              <thead className="bg-gray-50 text-gray-500">
                <tr>
                  <th className="px-3 py-2">å§“å</th>
                  <th className="px-3 py-2">å“é …</th>
                  <th className="px-3 py-2">å‚™è¨»</th>
                  <th className="px-3 py-2 text-right">æ“ä½œ</th>
                </tr>
              </thead>
              <tbody className="divide-y divide-gray-100">
                {orders.map((order: Order) => (
                  <tr key={order.id} className="hover:bg-gray-50">
                    <td className="px-3 py-2 font-medium">{order.userName}</td>
                    <td className="px-3 py-2">{order.itemName}</td>
                    <td className="px-3 py-2 text-gray-500">{order.note || '-'}</td>
                    <td className="px-3 py-2 text-right">
                      <button 
                        onClick={() => onDeleteOrder(order.id)}
                        className="text-gray-400 hover:text-red-500 transition-colors"
                        title="åˆªé™¤"
                      >
                        <Trash2 className="w-4 h-4" />
                      </button>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  );
}
